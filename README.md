# ada-config-generator

With this Proof-Of-Concept (POC) project I want to try an idea for Ada source
configuration from a GNAT Project file (gpr).

The equivalent for C/C++ would be the `config.h` file generated by a
`configure` script.

This can be particularly useful for embedded applications where we want to have
static declarations and static allocations as much as possible. For instance,
let the users of a library control the size of a statically allocated buffer.

Using the gpr file format means an out of the box integration in the GNAT
Programing Studio IDE and re-use of features such as scenario variable.

# Syntax

This POC uses only two attributes in a `Configuration` package:

 - `for Config_Type ("<NAME>") use "<TYPE>";`: defines the type used for the
   configuration key <NAME>

 - `for Config_Value ("<NAME>") use "<VALUE>";`: sets the value of the
   configuration key <NAME> and checks that it is a valid value for the type
   defined (if any)

These attributes can be combined with gpr file features such as scenario
variable, `external` and case statements (as shown in the example).

The supported types are `String`, `Enum`, `Boolean`, `Integer` and `Real`. 
With range support for `Integer` and `Real`.

# Generated code

The goal is to keep the generate code simple and without dependency at all. The
configuration values are declared constant, and named numbers are used for
`Real` and `Integer` types.

The `Real` and `Integer` types are not converted to constrained types in the
generated code, but rather defined as three named numbers (`First`, `Last` and
the config value). This way the application code can define its own type
including things that would be out of the scope of configuration (Alignment or
Size for instance).

Generated code:
```ada
package Config is
   Buffer_Size_First : constant := 1;
   Buffer_Size_Last  : constant := 1024;
   Buffer_Size       : constant := 256;
end Config;
```

Application:
```ada
   type Buffer_Size_Type
     is range Config.Buffer_Size_First .. Config.Buffer_Size_Last
     with Size => 16;

   Buffer_Size : constant Buffer_Size_Type:= Buffer_Size_Type (Config.Buffer_Size);
```
# Example

This examples covers most of the features implemented in the POC.

Project file:
```
project User_Project is

   type BUILD_TYPE is ("Debug", "Production");
   Build : BUILD_Type := external ("BUILD", "Debug");

   package Configuration is

      for Package_Name use "My_Config";

      for Config_Type ("Address") use "String";
      for Config_Value ("Address") use external ("Address", "example.com");

      for Config_Type ("Mode") use "Enum Mode1, Mode2, Mode3";
      for Config_Value ("Mode") use external ("Mode", "Mode1");

      for Config_Type ("Buffer_Size") use "Integer range 1 .. 4096";
      for Config_Value ("Buffer_Size") use external ("Buffer_Size", "256");

      for Config_Type ("Brightness") use "Real range 0.0 .. 1.0";
      for Config_Value ("Brightness") use external ("Brightness", "0.6");

      for Config_Type ("Verbose") use "Boolean";

      case Build is
         when "Debug" =>
            for Config_Value ("Verbose") use "True";
         when "Production" =>
            for Config_Value ("Verbose") use "False";
      end case;
   end Configuration;
end User_Project;
```

Generated code:
```ada
package My_Config is

   -- verbose --
   verbose : constant Boolean := True;

   -- brightness --
   brightness_First : constant := 0.0;
   brightness_Last : constant := 1.0;
   brightness : constant := 0.6;

   -- buffer_size --
   buffer_size_First : constant := 1;
   buffer_size_Last : constant := 4096;
   buffer_size : constant := 256;

   -- mode --
   type mode_Kind is (Test, Mode1, Mode2);
   mode : constant mode_Kind := Mode1;

   -- address --
   address : constant String := "example.com";

end My_Config;
```
